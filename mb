#!/bin/bash
#
# MessageBridge CLI
#
# Usage:
#   ./mb build [server|client|all]     - Build, sign, and create DMG
#   ./mb publish [server|client]       - Publish release to GitHub
#   ./mb release [server|client|all]   - Build and publish (does both)
#   ./mb help                          - Show this help
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$SCRIPT_DIR/Scripts"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    echo -e "${BLUE}MessageBridge CLI${NC}"
    echo ""
    echo "Usage: ./mb <command> [target]"
    echo ""
    echo "Commands:"
    echo "  build [server|client|all]    Build, sign, notarize, and create DMG"
    echo "  publish [server|client]      Create git tag and GitHub release"
    echo "  release [server|client|all]  Build AND publish (combines both)"
    echo "  help                         Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./mb build client            # Build signed client DMG"
    echo "  ./mb publish client          # Publish client to GitHub"
    echo "  ./mb release client          # Build and publish client"
    echo "  ./mb release all             # Build and publish both apps"
    echo ""
    echo "Setup:"
    echo "  1. Copy .env.example to .env and fill in your credentials"
    echo "  2. Install GitHub CLI: brew install gh && gh auth login"
}

cmd_build() {
    local target="${1:-all}"
    "$SCRIPTS_DIR/build-signed-release.sh" "$target"
}

cmd_publish() {
    local target="$1"
    if [[ -z "$target" ]] || [[ ! "$target" =~ ^(server|client)$ ]]; then
        echo -e "${RED}Error: publish requires 'server' or 'client'${NC}"
        echo "Usage: ./mb publish [server|client]"
        exit 1
    fi
    "$SCRIPTS_DIR/publish-release.sh" "$target"
}

cmd_release() {
    local target="${1:-all}"

    if [[ "$target" == "all" ]]; then
        echo -e "${BLUE}Building and publishing server...${NC}"
        "$SCRIPTS_DIR/build-signed-release.sh" server
        "$SCRIPTS_DIR/publish-release.sh" server

        echo ""
        echo -e "${BLUE}Building and publishing client...${NC}"
        "$SCRIPTS_DIR/build-signed-release.sh" client
        "$SCRIPTS_DIR/publish-release.sh" client
    else
        if [[ ! "$target" =~ ^(server|client)$ ]]; then
            echo -e "${RED}Error: release requires 'server', 'client', or 'all'${NC}"
            echo "Usage: ./mb release [server|client|all]"
            exit 1
        fi
        "$SCRIPTS_DIR/build-signed-release.sh" "$target"
        "$SCRIPTS_DIR/publish-release.sh" "$target"
    fi
}

# Main
COMMAND="${1:-help}"
TARGET="$2"

case "$COMMAND" in
    build)
        cmd_build "$TARGET"
        ;;
    publish)
        cmd_publish "$TARGET"
        ;;
    release)
        cmd_release "$TARGET"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
